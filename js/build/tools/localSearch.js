export default function initLocalSearch(){let e=config.path;if(!e)return void console.warn("`hexo-generator-searchdb` plugin is not installed!");let n,o=!1,r=!0;0===e.length?e="search.xml":e.endsWith("json")&&(r=!1);const t=document.querySelector(".search-input"),l=document.getElementById("search-result"),s=(e,t,n)=>{let o=e.length;if(0===o)return[];let r=0,l=[],s=[];for(n||(t=t.toLowerCase(),e=e.toLowerCase());(l=t.indexOf(e,r))>-1;)s.push({position:l,word:e}),r=l+o;return s},d=(t,e,n,o)=>{let r=n[n.length-1],{position:l,word:s}=r,i=[],a=0;for(;l+s.length<=e&&0!==n.length;){s===o&&a++,i.push({position:l,length:s.length});const t=l+s.length;n.pop();for(let e=n.length-1;e>=0&&(r=n[e],l=r.position,s=r.word,!(t<=l));e--)n.pop()}return{hits:i,start:t,end:e,searchTextCount:a}},g=(n,e)=>{let o="",r=e.start;return e.hits.forEach(e=>{o+=n.substring(r,e.position);let t=e.position+e.length;o+=`<b class="search-keyword">${n.substring(e.position,t)}</b>`,r=t}),o+=n.substring(r,e.end),o},i=()=>{if(!o)return;let u=t.value.trim().toLowerCase(),e=u.split(/[-\s]+/);e.length>1&&e.push(u);let p=[];if(u.length>0&&n.forEach(({title:r,content:i,url:l})=>{let t=r.toLowerCase(),n=i.toLowerCase(),a=[],c=[],h=0;if(e.forEach(e=>{a=a.concat(s(e,t,!1)),c=c.concat(s(e,n,!1))}),a.length>0||c.length>0){let e=a.length+c.length;[a,c].forEach(e=>{e.sort((e,t)=>t.position!==e.position?t.position-e.position:e.word.length-t.word.length)});let t=[];if(0!==a.length){let e=d(0,r.length,a,u);h+=e.searchTextCountInSlice,t.push(e)}let s=[];for(;0!==c.length;){let e=c[c.length-1],{position:t,word:n}=e,o=t-20,r=t+80;o<0&&(o=0),r<t+n.length&&(r=t+n.length),r>i.length&&(r=i.length);let l=d(o,r,c,u);h+=l.searchTextCountInSlice,s.push(l)}s.sort((e,t)=>e.searchTextCount!==t.searchTextCount?t.searchTextCount-e.searchTextCount:e.hits.length!==t.hits.length?t.hits.length-e.hits.length:e.start-t.start);let n=parseInt(theme.navbar.search.top_n_per_article?theme.navbar.search.top_n_per_article:1,10);n>=0&&(s=s.slice(0,n));let o="";0!==t.length?o+=`<li><a href="${l}" class="search-result-title">${g(r,t[0])}</a>`:o+=`<li><a href="${l}" class="search-result-title">${r}</a>`,s.forEach(e=>{o+=`<a href="${l}"><p class="search-result">${g(i,e)}...</p></a>`}),o+="</li>",p.push({item:o,id:p.length,hitCount:e,searchTextCount:h})}}),1===e.length&&""===e[0])l.innerHTML='<div id="no-result"><i class="fa-solid fa-magnifying-glass fa-5x"></i></div>';else if(0===p.length)l.innerHTML='<div id="no-result"><i class="fa-solid fa-box-open fa-5x"></i></div>';else{p.sort((e,t)=>e.searchTextCount!==t.searchTextCount?t.searchTextCount-e.searchTextCount:e.hitCount!==t.hitCount?t.hitCount-e.hitCount:t.id-e.id);let t='<ul class="search-result-list">';p.forEach(e=>{t+=e.item}),t+="</ul>",l.innerHTML=t,window.pjax&&window.pjax.refresh(l)}},a=()=>{fetch(config.root+e).then(e=>e.text()).then(e=>{o=!0,n=r?[...(new DOMParser).parseFromString(e,"text/xml").querySelectorAll("entry")].map(e=>({title:e.querySelector("title").textContent,content:e.querySelector("content").textContent,url:e.querySelector("url").textContent})):JSON.parse(e),n=n.filter(e=>e.title).map(e=>(e.title=e.title.trim(),e.content=e.content?e.content.trim().replace(/<[^>]+>/g,""):"",e.url=decodeURIComponent(e.url).replace(/\/{2,}/g,"/"),e));const t=document.querySelector("#no-result");t&&(t.innerHTML='<i class="fa-solid fa-magnifying-glass fa-5x"></i>')})};theme.navbar.search.preload&&a(),t&&t.addEventListener("input",i),document.querySelectorAll(".search-popup-trigger").forEach(e=>{e.addEventListener("click",()=>{document.body.style.overflow="hidden",document.querySelector(".search-pop-overlay").classList.add("active"),setTimeout(()=>t.focus(),500),o||a()})});const c=()=>{document.body.style.overflow="",document.querySelector(".search-pop-overlay").classList.remove("active")};document.querySelector(".search-pop-overlay").addEventListener("click",e=>{e.target===document.querySelector(".search-pop-overlay")&&c()}),document.querySelector(".search-input-field-pre").addEventListener("click",()=>{t.value="",t.focus(),i()}),document.querySelector(".popup-btn-close").addEventListener("click",c);try{swup.hooks.on("page:view",e=>{c()})}catch(e){}window.addEventListener("keyup",e=>{"Escape"===e.key&&c()})}