import{navbarShrink}from"./layouts/navbarShrink.js";import{initTOC}from"./layouts/toc.js";import{main}from"./main.js";import imageViewer from"./tools/imageViewer.js";export const navigationState={isNavigating:false};export default function initUtils(){const e={html_root_dom:document.querySelector("html"),pageContainer_dom:document.querySelector(".page-container"),pageTop_dom:document.querySelector(".main-content-header"),homeBanner_dom:document.querySelector(".home-banner-container"),homeBannerBackground_dom:document.querySelector(".home-banner-background"),scrollProgressBar_dom:document.querySelector(".scroll-progress-bar"),pjaxProgressBar_dom:document.querySelector(".pjax-progress-bar"),backToTopButton_dom:document.querySelector(".tool-scroll-to-top"),toolsList:document.querySelector(".hidden-tools-list"),toggleButton:document.querySelector(".toggle-tools-list"),innerHeight:window.innerHeight,pjaxProgressBarTimer:null,prevScrollValue:0,fontSizeLevel:0,triggerViewHeight:.5*window.innerHeight,isHasScrollProgressBar:theme.global.scroll_progress.bar===true,isHasScrollPercent:theme.global.scroll_progress.percentage===true,updateScrollStyle(){const e=window.pageYOffset||document.documentElement.scrollTop;const t=document.documentElement.scrollHeight;const o=window.innerHeight||document.documentElement.clientHeight;const n=this.calculatePercentage(e,t,o);this.updateScrollProgressBar(n);this.updateScrollPercent(n);this.updatePageTopVisibility(e,o);this.prevScrollValue=e},updateScrollProgressBar(e){if(this.isHasScrollProgressBar){const t=e.toFixed(3);const o=e===0?"hidden":"visible";this.scrollProgressBar_dom.style.visibility=o;this.scrollProgressBar_dom.style.width=`${t}%`}},updateScrollPercent(e){if(this.isHasScrollPercent){const t=this.backToTopButton_dom.querySelector(".percent");const o=e!==0&&e!==undefined;this.backToTopButton_dom.classList.toggle("show",o);t.innerHTML=e.toFixed(0)}},updatePageTopVisibility(e,t){if(theme.navbar.auto_hide){const o=this.prevScrollValue;const n=o>t&&e>o;this.pageTop_dom.classList.toggle("hide",n)}else{this.pageTop_dom.classList.remove("hide")}},calculatePercentage(e,t,o){let n=Math.round(e/(t-o)*100);if(isNaN(n)||n<0||!isFinite(n)){n=0}else if(n>100){n=100}return n},registerWindowScroll(){window.addEventListener("scroll",()=>{this.updateScrollStyle();this.updateTOCScroll();this.updateNavbarShrink();this.updateAutoHideTools()});window.addEventListener("scroll",this.debounce(()=>this.updateHomeBannerBlur(),20))},updateTOCScroll(){if(theme.articles.toc.enable&&initTOC().hasOwnProperty("updateActiveTOCLink")){initTOC().updateActiveTOCLink()}},updateNavbarShrink(){if(!navigationState.isNavigating){navbarShrink.init()}},debounce(e,t){let o;return function(){clearTimeout(o);o=setTimeout(()=>e.apply(this,arguments),t)}},updateHomeBannerBlur(){if(!this.homeBannerBackground_dom)return;if(theme.home_banner.style==="fixed"&&location.pathname===config.root){const e=window.scrollY||window.pageYOffset;const t=e>=this.triggerViewHeight?15:0;try{requestAnimationFrame(()=>{this.homeBannerBackground_dom.style.filter=`blur(${t}px)`;this.homeBannerBackground_dom.style.webkitFilter=`blur(${t}px)`})}catch(e){console.error("Error updating banner blur:",e)}}},updateAutoHideTools(){const t=window.scrollY;const o=document.body.scrollHeight;const n=window.innerHeight;const i=document.getElementsByClassName("right-side-tools-container");const s=document.getElementById("aplayer");for(let e=0;e<i.length;e++){const r=i[e];if(t<=100){if(location.pathname===config.root){r.classList.add("hide");if(s!==null){s.classList.add("hide")}}}else if(t+n>=o-20){r.classList.add("hide");if(s!==null){s.classList.add("hide")}}else{r.classList.remove("hide");if(s!==null){s.classList.remove("hide")}}}},toggleToolsList(){this.toggleButton.addEventListener("click",()=>{this.toolsList.classList.toggle("show")})},fontAdjPlus_dom:document.querySelector(".tool-font-adjust-plus"),fontAdMinus_dom:document.querySelector(".tool-font-adjust-minus"),globalFontSizeAdjust(){const o=this.html_root_dom;const e=this.fontAdjPlus_dom;const t=this.fontAdMinus_dom;const n=document.defaultView.getComputedStyle(document.body).fontSize;const i=parseFloat(n);let s=0;const r=main.getStyleStatus();if(r){s=r.fontSizeLevel;l(s)}function l(e){const t=i*(1+e*.05);o.style.fontSize=`${t}px`;main.styleStatus.fontSizeLevel=e;main.setStyleStatus()}function a(){s=Math.min(s+1,5);l(s)}function c(){s=Math.max(s-1,0);l(s)}e.addEventListener("click",a);t.addEventListener("click",c)},goComment(){this.goComment_dom=document.querySelector(".go-comment");if(this.goComment_dom){this.goComment_dom.addEventListener("click",()=>{const e=document.querySelector("#comment-anchor");if(e){const t=e.getBoundingClientRect().top+window.scrollY;window.scrollTo({top:t,behavior:"smooth"})}})}},getElementHeight(e){const t=document.querySelector(e);return t?t.getBoundingClientRect().height:0},inithomeBannerHeight(){this.homeBanner_dom&&(this.homeBanner_dom.style.height=this.innerHeight+"px")},initPageHeightHandle(){if(this.homeBanner_dom)return;const e=this.getElementHeight(".main-content-header");const t=this.getElementHeight(".main-content-body");const o=this.getElementHeight(".main-content-footer");const n=e+t+o;const i=window.innerHeight;const s=document.querySelector(".main-content-footer");if(n<i){const r=Math.floor(i-n);if(r>0){s.style.marginTop=`${r-2}px`}}},setHowLongAgoLanguage(e,t){return t.replace(/%s/g,e)},getHowLongAgo(e){const t=lang_ago;const o=Math.floor(e/(60*60*24*30)/12);const n=Math.floor(e/(60*60*24*30));const i=Math.floor(e/(60*60*24)/7);const s=Math.floor(e/(60*60*24));const r=Math.floor(e/(60*60)%24);const l=Math.floor(e/60%60);const a=Math.floor(e%60);if(o>0){return this.setHowLongAgoLanguage(o,t.year)}else if(n>0){return this.setHowLongAgoLanguage(n,t.month)}else if(i>0){return this.setHowLongAgoLanguage(i,t.week)}else if(s>0){return this.setHowLongAgoLanguage(s,t.day)}else if(r>0){return this.setHowLongAgoLanguage(r,t.hour)}else if(l>0){return this.setHowLongAgoLanguage(l,t.minute)}else if(a>0){return this.setHowLongAgoLanguage(a,t.second)}},relativeTimeInHome(){const e=document.querySelectorAll(".home-article-meta-info .home-article-date");const t=theme.home.article_date_format;if(t==="relative"){e&&e.forEach(e=>{const t=Date.now();const o=new Date(e.dataset.date.split(" GMT")[0]).getTime();e.innerHTML=this.getHowLongAgo(Math.floor((t-o)/1e3))})}else if(t==="auto"){e&&e.forEach(e=>{const t=Date.now();const o=new Date(e.dataset.date.split(" GMT")[0]).getTime();const n=Math.floor((t-o)/(60*60*24*1e3));if(n<7){e.innerHTML=this.getHowLongAgo(Math.floor((t-o)/1e3))}})}}};e.updateAutoHideTools();e.registerWindowScroll();e.toggleToolsList();e.globalFontSizeAdjust();e.goComment();e.initPageHeightHandle();e.inithomeBannerHeight();e.relativeTimeInHome();imageViewer()}